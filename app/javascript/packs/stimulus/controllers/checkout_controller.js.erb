import { Controller } from "stimulus"

export default class extends Controller {
	static targets = ["form", "submitButton"]

	connect() {
		this.formatter = new Intl.NumberFormat("de", {
			style: "currency",
			currency: "EUR"
		})

		$(this.formTarget).on('input', () => {
			if (
				!$('#order_delivery_attributes_address').val() ||
				!$('#order_delivery_attributes_phone').val() ||
				!$("[name='order[delivery_attributes][scheduled_at]']:checked")[0] ||
				!$("#order_payment_method_id option[value*='pm']:checked")[0]
			) {
				this.disableSubmitButton()
			} else {
				this.enableSubmitButton()
			}
		})
	}

	updateBreakdown(event) {
		fetch(
			routes.breakdown_api_v1_orders_path(),
			{
				method: "POST",
				body: new FormData(this.formTarget)
			}
		)
		.then(response => response.json())
		.then((data) => {
			$("#breakdown_subtotal").text(this.formatter.format(data.breakdown.subtotal))
			$("#breakdown_delivery").text(this.formatter.format(data.breakdown.delivery))
			$("#breakdown_total").text(this.formatter.format(data.breakdown.total))
		})
	}

	enableSubmitButton() {
		const button = this.submitButtonTarget

		button.style.cursor = "pointer"
		button.disabled = false
		button.classList.remove("btn-secondary")
		button.classList.add("btn-success")
	}

	disableSubmitButton() {
		const button = this.submitButtonTarget

		button.style.cursor = "not-allowed"
		button.disabled = true
		button.classList.remove("btn-success")
		button.classList.add("btn-secondary")
	}
}
